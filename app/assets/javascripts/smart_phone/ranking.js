// Generated by CoffeeScript 1.6.3
(function() {
  this.Ranking = (function() {
    function Ranking(selector, marketCode) {
      this.$target = $(selector);
      this.$activeContent = this.$target;
      this.$activeContent.addClass('active');
      ($("\#tab-" + marketCode)).addClass('active');
    }

    Ranking.prototype.isRankingPage = function() {
      return this.$activeContent.length !== 0;
    };

    Ranking.prototype.isUpdatable = function() {
      return true;
    };

    Ranking.prototype.loadRankingData = function(callback, options) {
      if (this.isUpdatable()) {
        return $.get("" + (URLHelper.rankingUrl({})) + ".json", callback);
      } else {

      }
    };

    Ranking.prototype.generateFeedGroup = function(feeds) {
      var $button, $group, $groupWrapper, feed, url, width, _i, _len;
      $groupWrapper = $('<div/>', {
        "class": 'btn-group btn-group-justified feed-group'
      });
      width = 100 / feeds.length;
      for (_i = 0, _len = feeds.length; _i < _len; _i++) {
        feed = feeds[_i];
        $group = $('<div/>', {
          "class": 'btn-group',
          width: "" + width + "%"
        });
        url = URLHelper.rankingUrl({
          feed: feed.code
        });
        $button = ($('<button/>', {
          type: 'button',
          "class": 'btn btn-default',
          id: "feed-" + feed.code,
          onclick: "location.href = '" + url + "'"
        })).text(feed.name);
        $groupWrapper.append($group.append($button));
      }
      return $groupWrapper;
    };

    Ranking.prototype.activateFeed = function(feed) {
      return ($("#feed-" + feed.code)).addClass('selected');
    };

    Ranking.prototype.generateAppIconImage = function(app_item) {
      var $image, dummy;
      dummy = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC';
      $image = app_item.banner_url != null ? $('<img/>', {
        "class": 'app-banner lazy',
        'data-original': app_item.banner_url,
        src: dummy
      }) : $('<img/>', {
        "class": 'app-icon lazy',
        'data-original': app_item.icon,
        src: dummy
      });
      return $image.lazyload({
        effect: 'fadeIn'
      });
    };

    Ranking.prototype.generateAppIcon = function(app_item) {
      var $a;
      $a = $('<a/>', {
        href: URLHelper.appItemUrl(app_item.id)
      });
      return $a.append(this.generateAppIconImage(app_item));
    };

    Ranking.prototype.generateAppTitle = function(app_item) {
      var $title;
      return $title = ($('<div/>', {
        "class": 'app-title'
      })).text(app_item.name);
    };

    Ranking.prototype.generateAppRank = function(rank) {
      return ($('<div/>', {
        "class": 'app-rank'
      })).text(rank);
    };

    Ranking.prototype.generateAppInfoHeader = function(app_item, rank) {
      var $div;
      $div = $('<div/>', {
        "class": 'app-info-header'
      });
      $div.append(this.generateAppRank(rank));
      return $div.append(this.generateAppTitle(app_item));
    };

    Ranking.prototype.generateAppDetail = function(app_item) {
      return this.generateAppTitle(app_item);
    };

    Ranking.prototype.generateAppInfo = function(app_item, rank) {
      var $div;
      $div = $('<div/>', {
        "class": 'app-info'
      });
      $div.append(this.generateAppIcon(app_item));
      return $div.append(this.generateAppDetail(app_item));
    };

    Ranking.prototype.generateReleaseDate = function(app_item) {
      var $div;
      $div = $('<div/>', {
        "class": 'app-release-date'
      });
      return $div.text('Release: xx月yy日 上旬頃');
    };

    Ranking.prototype.generateBonusInfo = function(app_item) {
      var $div, bonus;
      $div = $('<div/>', {
        "class": 'app-bonus'
      });
      bonus = app_item.reservation_information.bonus;
      if ((Object.keys(bonus)).length !== 0) {
        $div.addClass('btn btn-bonus');
        return $div.text('予約特典あり');
      }
    };

    Ranking.prototype.generateOverlapInfoArea = function(app_item) {
      var $div;
      $div = $('<div/>', {
        "class": 'overlap-app-info'
      });
      $div.append(this.generateReleaseDate(app_item));
      return $div.append(this.generateBonusInfo(app_item));
    };

    Ranking.prototype.generateAppInfoLarge = function(app_item, rank) {
      var $div;
      $div = $('<div/>', {
        "class": 'app-info'
      });
      $div.append(this.generateAppInfoHeader(app_item, rank));
      $div.append(this.generateAppIcon(app_item));
      return $div.append(this.generateOverlapInfoArea(app_item));
    };

    Ranking.prototype.generateRankingTd = function(app_item, idx) {
      var $td;
      $td = $('<td/>');
      if (app_item != null) {
        if (app_item.banner_url == null) {
          $td.addClass('app-data');
          $td.append(this.generateAppInfo(app_item, idx + 1));
        } else {
          $td.addClass('app-data-large');
          $td.append(this.generateAppInfoLarge(app_item, idx + 1));
        }
      }
      return $td;
    };

    Ranking.prototype.generateRankIndex = function(idx) {
      return ($('<td/>', {
        "class": 'rank-index'
      })).text(idx);
    };

    Ranking.prototype.generateRankingTbody = function(data) {
      var $tbody, $tbodyTr, app_item, idx, record, _i, _j, _len, _results;
      $tbody = $('<tbody/>');
      _results = [];
      for (idx = _i = 0; _i < 20; idx = ++_i) {
        $tbodyTr = $('<tr/>');
        for (_j = 0, _len = data.length; _j < _len; _j++) {
          record = data[_j];
          if (record.ranking.app_items != null) {
            app_item = record.ranking.app_items[idx];
            $tbodyTr.append(this.generateRankingTd(app_item, idx));
          }
        }
        _results.push($tbody.append($tbodyTr));
      }
      return _results;
    };

    Ranking.prototype.generateFeedName = function(name, width) {
      return (($('<th/>')).css({
        display: 'none',
        width: width
      })).text(name);
    };

    Ranking.prototype.generateRankCol = function() {
      return $('<th/>', {
        "class": 'col-md-1'
      });
    };

    Ranking.prototype.generateRankingTr = function(data) {
      var $th, $theadTr, record, width, _i, _len, _results;
      width = 100 / data.length;
      $theadTr = $('<tr/>');
      _results = [];
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        record = data[_i];
        $th = this.generateFeedName(record.feed.name, width);
        $th.css({
          width: width
        });
        _results.push($theadTr.append($th));
      }
      return _results;
    };

    Ranking.prototype.generateRankingThead = function(data) {
      return ($('<thead/>')).append(this.generateRankingTr(data));
    };

    Ranking.prototype.generateRanking = function() {
      var callback,
        _this = this;
      callback = function(data, status, xhr) {
        var $table, $tbody, $thead;
        console.log(data);
        $table = $('<table/>', {
          "class": 'table table-hover table-striped table-bordered app-table'
        });
        $thead = _this.generateRankingThead(data);
        $tbody = _this.generateRankingTbody(data);
        $table.append($thead);
        $table.append($tbody);
        $table.hide();
        _this.$activeContent.append(_this.generateFeedGroup(gon.feeds));
        _this.activateFeed(gon.feed);
        _this.$activeContent.append($table);
        $table.fadeIn('slow');
        return ($(document)).scroll();
      };
      return this.loadRankingData(callback);
    };

    return Ranking;

  })();

  $(document).on('ready page:load', function() {
    var ranking;
    if (URLHelper.isRankingUrl(location.href)) {
      if (window.position != null) {
        ($(document)).scrollTop(window.position);
      }
      ranking = new Ranking('.ranking-content', gon.market.code.toLowerCase());
      return ranking.generateRanking();
    }
  });

  $(document).on('page:before-change', function() {
    window.position = 0;
    if (URLHelper.isRankingUrl(location.href)) {
      return window.position = ($(document)).scrollTop();
    }
  });

}).call(this);
