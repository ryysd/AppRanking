// Generated by CoffeeScript 1.6.3
(function() {
  this.Ranking = (function() {
    function Ranking(selector, marketCode) {
      this.$target = $(selector);
      this.$activeContent = this.$target;
      console.log(this.$activeContent);
      this.$activeContent.addClass('active');
      ($("\#tab-" + marketCode)).addClass('active');
    }

    Ranking.prototype.isRankingPage = function() {
      return this.$activeContent != null;
    };

    Ranking.prototype.isUpdatable = function() {
      return true;
    };

    Ranking.prototype.loadRankingData = function(callback, options) {
      if (this.isUpdatable()) {
        return $.get("" + window.location.href + ".json", callback);
      } else {

      }
    };

    Ranking.prototype.generateHeader = function(title) {
      var $categorySelector, $countrySelector, $header, $title, categories, category, countries, country;
      $header = $('<div/>', {
        "class": 'ranking-header'
      });
      $title = ($('<div/>', {
        "class": 'ranking-title col-md-7'
      })).text(title);
      $countrySelector = $('<div/>', {
        "class": 'col-md-2',
        id: 'country-selector'
      });
      $categorySelector = $('<div/>', {
        "class": 'col-md-2',
        id: 'category-selector'
      });
      $header.append($title);
      $header.append($categorySelector);
      $header.append($countrySelector);
      this.$target.append($header);
      countries = (function() {
        var _i, _len, _ref, _results;
        _ref = gon.countries;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          country = _ref[_i];
          _results.push({
            name: country.name,
            opts: {
              id: country.code,
              href: URLHelper.rankingUrl({
                country: country.code
              })
            }
          });
        }
        return _results;
      })();
      categories = (function() {
        var _i, _len, _ref, _results;
        _ref = gon.categories;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          category = _ref[_i];
          _results.push({
            name: category.name,
            opts: {
              id: category.code,
              href: URLHelper.rankingUrl({
                category: category.code
              })
            }
          });
        }
        return _results;
      })();
      DropdownSelector.insert('#country-selector', countries);
      DropdownSelector.insert('#category-selector', categories);
      ($("\#" + gon.country.code)).click();
      return ($("\#" + gon.category.code)).click();
    };

    Ranking.prototype.generateRanking = function() {
      var bootColWidth, callback, dummy,
        _this = this;
      bootColWidth = 12;
      dummy = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC';
      callback = function(data, status, xhr) {
        var $a, $div, $image, $table, $tbody, $tbodyTr, $td, $th, $thead, $theadTr, $title, app_item, colSize, idx, record, _i, _j, _k, _len, _len1;
        $table = $('<table/>', {
          "class": 'table table-hover table-striped table-bordered app-table'
        });
        $thead = $('<thead/>');
        $theadTr = $('<tr/>');
        colSize = parseInt((bootColWidth - 1) / data.length);
        $theadTr.append($('<th/>', {
          "class": 'col-md-1'
        }));
        for (_i = 0, _len = data.length; _i < _len; _i++) {
          record = data[_i];
          console.log(record);
          $th = ($('<th/>', {
            "class": "col-md-" + colSize + " feed-name"
          })).text(record.feed.name);
          $theadTr.append($th);
        }
        $tbody = $('<tbody/>');
        for (idx = _j = 0; _j < 20; idx = ++_j) {
          $tbodyTr = $('<tr/>');
          $tbodyTr.append(($('<td/>', {
            "class": 'rank-index'
          })).text(idx + 1));
          for (_k = 0, _len1 = data.length; _k < _len1; _k++) {
            record = data[_k];
            if (record.ranking.app_items != null) {
              app_item = record.ranking.app_items[idx];
              $td = $('<td/>');
              if (app_item != null) {
                $div = $('<div/>', {
                  "class": 'app-info'
                });
                $title = ($('<div/>', {
                  "class": 'app-title'
                })).text(app_item.name);
                $a = $('<a/>', {
                  href: app_item.website_url
                });
                $image = $('<img/>', {
                  "class": 'app-icon lazy',
                  'data-original': app_item.icon,
                  src: dummy
                });
                $image.lazyload({
                  effect: 'fadeIn'
                });
                $a.append($image);
                $div.append($a);
                $div.append($title);
                $td.append($div);
              }
              $tbodyTr.append($td);
            }
          }
          $tbody.append($tbodyTr);
        }
        $thead.append($theadTr);
        $table.append($thead);
        $table.append($tbody);
        $table.hide();
        _this.$activeContent.append($table);
        $table.fadeIn('slow');
        return ($(document)).scroll();
      };
      return this.loadRankingData(callback);
    };

    return Ranking;

  })();

  $(document).on('ready page:load', function() {
    var ranking;
    if (window.position != null) {
      ($(document)).scrollTop(window.position);
    }
    ranking = new Ranking('.ranking-content', gon.market.code.toLowerCase());
    if (ranking.isRankingPage()) {
      ranking.generateHeader("" + gon.market.name + " Apps Ranking");
      return ranking.generateRanking();
    }
  });

  $(document).on('page:before-change', function() {
    return window.position = ($(document)).scrollTop();
  });

}).call(this);
